<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Miami Night - Pixel Combat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: none;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        body {
            background: #0a0a0a;
            overflow: hidden;
            font-family: 'Courier New', monospace;
            color: #ff0066;
        }

        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            background: #1a1a2e;
        }

        /* Меню */
        #menuScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #0a0a0a, #1a0a2e);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        .title {
            font-size: 48px;
            color: #ff0066;
            text-shadow: 0 0 10px #ff0066;
            margin-bottom: 30px;
            text-align: center;
        }

        .level-select {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .level-btn {
            padding: 15px 25px;
            background: #ff0066;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .level-btn:hover {
            background: #ff3388;
            transform: scale(1.1);
        }

        .level-btn.locked {
            background: #666;
            cursor: not-allowed;
        }

        /* Управление */
        #leftJoystick {
            position: absolute;
            bottom: 120px;
            left: 60px;
            width: 100px;
            height: 100px;
            background: rgba(255, 0, 102, 0.2);
            border: 2px solid #ff0066;
            border-radius: 50%;
            z-index: 5;
        }

        .joystick-knob {
            position: absolute;
            width: 40px;
            height: 40px;
            background: #ff0066;
            border-radius: 50%;
            top: 30px;
            left: 30px;
            transition: transform 0.1s;
        }

        #rightJoystick {
            position: absolute;
            bottom: 120px;
            right: 60px;
            width: 100px;
            height: 100px;
            background: rgba(0, 255, 255, 0.2);
            border: 2px solid #00ffff;
            border-radius: 50%;
            z-index: 5;
        }

        #shootZone {
            position: absolute;
            top: 50px;
            left: 50px;
            width: 150px;
            height: 100px;
            background: rgba(255, 255, 0, 0.1);
            border: 1px dashed yellow;
            z-index: 5;
        }

        /* Победа */
        #winScreen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border: 3px solid #ff0066;
            border-radius: 10px;
            text-align: center;
            z-index: 20;
            display: none;
        }

        #nextLevel {
            margin-top: 20px;
            padding: 10px 20px;
            background: #ff0066;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        
        <!-- Меню -->
        <div id="menuScreen">
            <div class="title">MIAMI NIGHT</div>
            <div class="level-select">
                <button class="level-btn" data-level="1">Уровень 1</button>
                <button class="level-btn" data-level="2">Уровень 2</button>
                <button class="level-btn" data-level="3">Уровень 3</button>
                <button class="level-btn" data-level="4">Уровень 4</button>
                <button class="level-btn" data-level="5">Уровень 5</button>
            </div>
        </div>

        <!-- Управление -->
        <div id="leftJoystick">
            <div class="joystick-knob" id="leftKnob"></div>
        </div>
        <div id="rightJoystick">
            <div class="joystick-knob" id="rightKnob"></div>
        </div>
        <div id="shootZone"></div>

        <!-- Экран победы -->
        <div id="winScreen">
            <h2>ТЫ ВЫИГРАЛ!</h2>
            <button id="nextLevel">ДАЛЬШЕ</button>
        </div>
    </div>

    <script>
        class MiamiGame {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.menuScreen = document.getElementById('menuScreen');
                this.winScreen = document.getElementById('winScreen');
                this.nextLevelBtn = document.getElementById('nextLevel');
                
                this.setupCanvas();
                this.setupControls();
                this.setupLevels();
                this.setupMenu();
                
                this.currentLevel = 1;
                this.gameState = 'menu'; // menu, playing, win
                
                this.camera = { x: 0, y: 0 };
                this.bloodParticles = [];
                
                this.gameLoop();
            }

            setupCanvas() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                this.worldWidth = 2000;
                this.worldHeight = 800;
            }

            setupControls() {
                this.keys = {};
                this.touches = new Map();
                
                // Джойстики
                this.leftJoystick = { x: 0, y: 0, active: false };
                this.rightJoystick = { x: 0, y: 0, active: false };
                this.shooting = false;
                
                this.setupTouchControls();
            }

            setupTouchControls() {
                const leftStick = document.getElementById('leftJoystick');
                const rightStick = document.getElementById('rightJoystick');
                const shootZone = document.getElementById('shootZone');
                const leftKnob = document.getElementById('leftKnob');
                const rightKnob = document.getElementById('rightKnob');

                // Левый джойстик - движение
                this.setupJoystick(leftStick, leftKnob, (x, y) => {
                    this.leftJoystick.x = x;
                    this.leftJoystick.y = y;
                    this.leftJoystick.active = true;
                }, () => {
                    this.leftJoystick.active = false;
                });

                // Правый джойстик - направление оружия
                this.setupJoystick(rightStick, rightKnob, (x, y) => {
                    this.rightJoystick.x = x;
                    this.rightJoystick.y = y;
                    this.rightJoystick.active = true;
                }, () => {
                    this.rightJoystick.active = false;
                });

                // Зона стрельбы
                shootZone.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.shooting = true;
                });

                shootZone.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.shooting = false;
                });
            }

            setupJoystick(container, knob, onMove, onEnd) {
                let touchId = null;

                container.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    if (touchId === null) {
                        const touch = e.touches[0];
                        touchId = touch.identifier;
                        this.updateJoystick(touch, container, knob, onMove);
                    }
                });

                container.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    for (let touch of e.touches) {
                        if (touch.identifier === touchId) {
                            this.updateJoystick(touch, container, knob, onMove);
                            break;
                        }
                    }
                });

                container.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    for (let touch of e.changedTouches) {
                        if (touch.identifier === touchId) {
                            touchId = null;
                            knob.style.transform = 'translate(0, 0)';
                            onEnd();
                            break;
                        }
                    }
                });
            }

            updateJoystick(touch, container, knob, onMove) {
                const rect = container.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                let x = (touch.clientX - centerX) / (rect.width / 2);
                let y = (touch.clientY - centerY) / (rect.height / 2);
                
                // Ограничение радиуса
                const length = Math.sqrt(x * x + y * y);
                if (length > 1) {
                    x /= length;
                    y /= length;
                }
                
                knob.style.transform = `translate(${x * 30}px, ${y * 30}px)`;
                onMove(x, y);
            }

            setupLevels() {
                this.levels = {
                    1: this.createLevel(5),
                    2: this.createLevel(8),
                    3: this.createLevel(12),
                    4: this.createLevel(15),
                    5: this.createLevel(20)
                };
            }

            createLevel(enemyCount) {
                const level = {
                    player: { x: 100, y: 400, width: 16, height: 16, speed: 3 },
                    enemies: [],
                    walls: this.generateWalls()
                };

                // Создаем врагов в случайных позициях
                for (let i = 0; i < enemyCount; i++) {
                    level.enemies.push({
                        x: 300 + Math.random() * 1500,
                        y: 100 + Math.random() * 500,
                        width: 16,
                        height: 16,
                        alive: true,
                        type: Math.floor(Math.random() * 3)
                    });
                }

                return level;
            }

            generateWalls() {
                const walls = [];
                // Внешние стены
                walls.push({ x: 0, y: 0, width: this.worldWidth, height: 20 }); // верх
                walls.push({ x: 0, y: this.worldHeight - 20, width: this.worldWidth, height: 20 }); // низ
                walls.push({ x: 0, y: 0, width: 20, height: this.worldHeight }); // лево
                walls.push({ x: this.worldWidth - 20, y: 0, width: 20, height: this.worldHeight }); // право

                // Внутренние стены (комнаты)
                for (let i = 0; i < 8; i++) {
                    const x = 200 + Math.random() * 1400;
                    const y = 100 + Math.random() * 400;
                    const width = 80 + Math.random() * 120;
                    const height = 60 + Math.random() * 80;
                    
                    walls.push({ x, y, width, height: 10 }); // верх стены
                    walls.push({ x, y + height, width, height: 10 }); // низ стены
                    walls.push({ x, y, width: 10, height }); // лево стены
                    walls.push({ x: x + width - 10, y, width: 10, height }); // право стены
                }

                return walls;
            }

            setupMenu() {
                const levelButtons = document.querySelectorAll('.level-btn');
                levelButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const level = parseInt(btn.dataset.level);
                        if (!btn.classList.contains('locked')) {
                            this.startLevel(level);
                        }
                    });
                });

                this.nextLevelBtn.addEventListener('click', () => {
                    this.winScreen.style.display = 'none';
                    this.currentLevel++;
                    if (this.currentLevel > 5) {
                        this.currentLevel = 1;
                    }
                    this.startLevel(this.currentLevel);
                });
            }

            startLevel(level) {
                this.currentLevel = level;
                this.gameState = 'playing';
                this.menuScreen.style.display = 'none';
                this.winScreen.style.display = 'none';
                
                this.level = JSON.parse(JSON.stringify(this.levels[level]));
                this.bloodParticles = [];
                
                // Сброс камеры
                this.camera.x = this.level.player.x - this.canvas.width / 2;
                this.camera.y = this.level.player.y - this.canvas.height / 2;
            }

            update() {
                if (this.gameState !== 'playing') return;

                this.updatePlayer();
                this.updateCamera();
                this.updateBlood();
                this.checkWinCondition();
            }

            updatePlayer() {
                const player = this.level.player;
                
                // Движение с джойстика
                if (this.leftJoystick.active) {
                    player.x += this.leftJoystick.x * player.speed;
                    player.y += this.leftJoystick.y * player.speed;
                }

                // Ограничение в пределах мира
                player.x = Math.max(20, Math.min(this.worldWidth - 20 - player.width, player.x));
                player.y = Math.max(20, Math.min(this.worldHeight - 20 - player.height, player.y));

                // Стрельба
                if (this.shooting && this.rightJoystick.active) {
                    this.shoot();
                }
            }

            shoot() {
                const player = this.level.player;
                
                // Находим ближайшего врага
                let closestEnemy = null;
                let minDist = Infinity;
                
                this.level.enemies.forEach(enemy => {
                    if (enemy.alive) {
                        const dx = enemy.x - player.x;
                        const dy = enemy.y - player.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        
                        if (dist < minDist && dist < 300) {
                            minDist = dist;
                            closestEnemy = enemy;
                        }
                    }
                });
                
                // Убиваем врага и создаем кровь
                if (closestEnemy) {
                    closestEnemy.alive = false;
                    this.createBlood(closestEnemy.x, closestEnemy.y);
                }
            }

            createBlood(x, y) {
                for (let i = 0; i < 15; i++) {
                    this.bloodParticles.push({
                        x: x + 8,
                        y: y + 8,
                        vx: (Math.random() - 0.5) * 8,
                        vy: (Math.random() - 0.5) * 8,
                        life: 1.0,
                        decay: 0.02 + Math.random() * 0.02
                    });
                }
            }

            updateBlood() {
                for (let i = this.bloodParticles.length - 1; i >= 0; i--) {
                    const particle = this.bloodParticles[i];
                    particle.x += particle.vx;
                    particle.y += particle.vy;
                    particle.vy += 0.2; // гравитация
                    particle.life -= particle.decay;
                    
                    if (particle.life <= 0) {
                        this.bloodParticles.splice(i, 1);
                    }
                }
            }

            updateCamera() {
                const player = this.level.player;
                const targetX = player.x - this.canvas.width / 2;
                const targetY = player.y - this.canvas.height / 2;
                
                // Плавное движение камеры с запаздыванием
                this.camera.x += (targetX - this.camera.x) * 0.1;
                this.camera.y += (targetY - this.camera.y) * 0.1;
                
                // Ограничение камеры в пределах мира
                this.camera.x = Math.max(0, Math.min(this.worldWidth - this.canvas.width, this.camera.x));
                this.camera.y = Math.max(0, Math.min(this.worldHeight - this.canvas.height, this.camera.y));
            }

            checkWinCondition() {
                const aliveEnemies = this.level.enemies.filter(enemy => enemy.alive);
                if (aliveEnemies.length === 0) {
                    this.gameState = 'win';
                    this.winScreen.style.display = 'block';
                }
            }

            render() {
                // Очистка
                this.ctx.fillStyle = '#1a1a2e';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                if (this.gameState !== 'playing') return;
                
                this.ctx.save();
                this.ctx.translate(-this.camera.x, -this.camera.y);
                
                // Рендер стен
                this.ctx.fillStyle = '#333344';
                this.level.walls.forEach(wall => {
                    this.ctx.fillRect(wall.x, wall.y, wall.width, wall.height);
                });
                
                // Рендер крови
                this.ctx.fillStyle = '#ff0000';
                this.bloodParticles.forEach(particle => {
                    this.ctx.globalAlpha = particle.life;
                    this.ctx.fillRect(
                        Math.floor(particle.x),
                        Math.floor(particle.y),
                        3, 3
                    );
                });
                this.ctx.globalAlpha = 1;
                
                // Рендер игрока
                this.ctx.fillStyle = '#ff0066';
                this.ctx.fillRect(
                    Math.floor(this.level.player.x),
                    Math.floor(this.level.player.y),
                    this.level.player.width,
                    this.level.player.height
                );
                
                // Рендер врагов
                this.level.enemies.forEach(enemy => {
                    if (enemy.alive) {
                        this.ctx.fillStyle = enemy.type === 0 ? '#00ff00' : 
                                           enemy.type === 1 ? '#ffff00' : '#00ffff';
                        this.ctx.fillRect(
                            Math.floor(enemy.x),
                            Math.floor(enemy.y),
                            enemy.width,
                            enemy.height
                        
